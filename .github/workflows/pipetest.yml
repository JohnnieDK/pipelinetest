name: Linting

on: [push]

env:
  TERRAFORM_VERSION: '0.12.29'

jobs:
  lint-tf:
    runs-on: ubuntu-latest
    container: linuxbrew/brew:latest

    steps:
    - uses: actions/checkout@v1
    - name: install terraform/grunt
      run: |
        brew install terragrunt

    - name: docker build
      # If using the default 'powershell' shell, GitHub will swallow
      # any PowerShell errors and just do 'exit 1'
      # This ensures we get the full output if any errors occurs.
      env:
        DOCKER_IMAGE: 'odin-sitecore-xm-cd:9.3.0'
      run: ls

    - name: terraform fmt
      id: terraform
      run: |
        apt update
        apt install wget unzip
        mkdir terraform
        wget -q https://releases.hashicorp.com/terraform/${{ env.TERRAFORM_VERSION }}/terraform_${{ env.TERRAFORM_VERSION }}_linux_amd64.zip
        unzip terraform_${{ env.TERRAFORM_VERSION }}_linux_amd64.zip -d /bin/
        terraform version
        terraform fmt -check -recursive -diff -no-color

    - name: terragrunt hclfmt
      id: grunt
      run: |
        terragrunt hclfmt --terragrunt-check